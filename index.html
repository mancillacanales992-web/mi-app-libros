<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MI BIBLIOTECA - App Ultimate</title>

    <style>
        html, body { overscroll-behavior-y: contain; }

        /* --- 1. SISTEMA DE TEMAS (BASE) --- */
        :root {
            --bg-wall: #1e1e24; 
            --brick-1: #25252d; --brick-2: #2b2b36;
            --ui-bg: rgba(255, 255, 255, 0.08);
            --ui-border: rgba(255, 255, 255, 0.15);
            --header-bg: rgba(30, 30, 36, 0.98);
            --text-main: #f0f0f0; --text-muted: #b0b0b0;
            --accent: #00e5ff; --accent-glow: rgba(0, 229, 255, 0.25);
            /* Colores Feed */
            --like-color: #00e676;
            --disagree-color: #ff1744;
        }
        /* Temas (Intactos) */
        body.theme-orange { --bg-wall: #1a1008; --brick-1: #26170b; --brick-2: #331f0e; --ui-bg: rgba(255, 140, 0, 0.08); --ui-border: rgba(255, 140, 0, 0.3); --header-bg: rgba(26, 16, 8, 0.98); --text-main: #fff0e0; --text-muted: #d0b0a0; --accent: #ff6d00; --accent-glow: rgba(255, 109, 0, 0.4); }
        body.theme-silver { --bg-wall: #212121; --brick-1: #2c2c2c; --brick-2: #383838; --ui-bg: rgba(200, 200, 200, 0.08); --ui-border: rgba(200, 200, 200, 0.2); --header-bg: rgba(33, 33, 33, 0.98); --text-main: #ffffff; --text-muted: #9e9e9e; --accent: #b0bec5; --accent-glow: rgba(176, 190, 197, 0.3); }
        body.theme-red { --bg-wall: #1a0505; --brick-1: #290a0a; --brick-2: #380e0e; --ui-bg: rgba(255, 50, 50, 0.08); --ui-border: rgba(255, 82, 82, 0.3); --header-bg: rgba(26, 5, 5, 0.98); --text-main: #ffebee; --text-muted: #e57373; --accent: #ff1744; --accent-glow: rgba(255, 23, 68, 0.4); }
        body.theme-blue { --bg-wall: #050a1a; --brick-1: #0a1433; --brick-2: #0f1e4d; --ui-bg: rgba(68, 138, 255, 0.08); --ui-border: rgba(68, 138, 255, 0.3); --header-bg: rgba(5, 10, 26, 0.98); --text-main: #e3f2fd; --text-muted: #90caf9; --accent: #2979ff; --accent-glow: rgba(41, 121, 255, 0.4); }
        body.theme-green { --bg-wall: #051a0a; --brick-1: #0a2910; --brick-2: #103816; --ui-bg: rgba(0, 230, 118, 0.08); --ui-border: rgba(0, 230, 118, 0.3); --header-bg: rgba(5, 26, 10, 0.98); --text-main: #e8f5e9; --text-muted: #a5d6a7; --accent: #00e676; --accent-glow: rgba(0, 230, 118, 0.4); }
        body.theme-purple { --bg-wall: #12051a; --brick-1: #1f0a2e; --brick-2: #2d0e42; --ui-bg: rgba(213, 0, 249, 0.08); --ui-border: rgba(213, 0, 249, 0.3); --header-bg: rgba(18, 5, 26, 0.98); --text-main: #f3e5f5; --text-muted: #ce93d8; --accent: #d500f9; --accent-glow: rgba(213, 0, 249, 0.4); }
        body.theme-gold { --bg-wall: #141005; --brick-1: #241d0a; --brick-2: #33290e; --ui-bg: rgba(255, 215, 0, 0.08); --ui-border: rgba(255, 215, 0, 0.3); --header-bg: rgba(20, 16, 5, 0.98); --text-main: #fffde7; --text-muted: #fff59d; --accent: #ffca28; --accent-glow: rgba(255, 202, 40, 0.4); }

        body {
            margin: 0; font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-wall);
            background-image: 
                linear-gradient(335deg, var(--brick-1) 23px, transparent 23px),
                linear-gradient(155deg, var(--brick-2) 23px, transparent 23px),
                linear-gradient(335deg, var(--brick-1) 23px, transparent 23px),
                linear-gradient(155deg, var(--brick-2) 23px, transparent 23px);
            background-size: 58px 58px;
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh; overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- NUEVO: FAB (Bot√≥n Flotante) --- */
        .fab-btn {
            position: fixed; bottom: 75px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent); color: #000;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px var(--accent-glow);
            z-index: 600; font-size: 24px; border: none; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }
        .fab-btn svg { width: 28px; height: 28px; fill: currentColor; }

        /* --- NUEVO: T√©rminos y Condiciones --- */
        .terms-container {
            display: flex; align-items: flex-start; gap: 10px; margin: 15px 0;
            text-align: left; font-size: 11px; color: var(--text-muted);
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;
        }
        .terms-link { color: var(--accent); text-decoration: underline; cursor: pointer; margin-left: 3px; }

        /* --- NUEVO: Contador de Usuarios (Robot) --- */
        .online-counter {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px;
            font-size: 11px; color: var(--accent); border: 1px solid var(--ui-border);
            margin-bottom: 15px;
        }
        .online-dot { width: 8px; height: 8px; background: #00e676; border-radius: 50%; box-shadow: 0 0 5px #00e676; }
        
        /* --- 2. MODAL DE NOTAS (REDISE√ëO GLASS/MODERNO) --- */
        #notes-modal .modal-content {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--accent);
            box-shadow: 0 0 25px rgba(0,0,0,0.8), 0 0 10px var(--accent-glow);
            max-width: 90%; width: 350px;
            border-radius: 20px;
        }
        
        .notes-textarea {
            width: 100%; box-sizing: border-box;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 15px;
            color: #eee; font-family: 'Courier New', monospace;
            font-size: 14px; line-height: 1.5; resize: none; outline: none;
            margin-top: 10px; transition: 0.3s;
        }
        .notes-textarea:focus {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* --- 3. MODAL DE PERFIL (ONBOARDING) --- */
        #profile-setup-modal { z-index: 10000; }
        
        .avatar-grid {
            display: flex; justify-content: center; gap: 10px; margin: 20px 0;
            flex-wrap: wrap;
        }
        .avatar-option {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.1); font-size: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent; transition: 0.3s;
        }
        .avatar-option:hover { background: rgba(255,255,255,0.2); }
        .avatar-option.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* --- 4. ESTILOS MURO SOCIAL --- */
        .social-feed { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        
        .create-post-card {
            background: var(--ui-bg); border: 1px solid var(--ui-border); 
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        
        .social-card { 
            background: rgba(30, 30, 36, 0.6); border: 1px solid var(--ui-border); 
            border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: 0.3s; position: relative;
        }

        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-avatar { 
            width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.1); 
            color: #fff; font-weight: bold; display: flex; align-items: center; 
            justify-content: center; font-size: 18px; border: 1px solid var(--ui-border);
        }
        .post-meta { flex: 1; }
        .post-author { font-size: 14px; font-weight: bold; color: var(--text-main); display: block; }
        .post-date { font-size: 11px; color: var(--text-muted); }
        
        /* Etiquetas y Botones Admin */
        .admin-badge {
            color: #ffd700; background: rgba(255, 215, 0, 0.15); border: 1px solid #ffd700;
            padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 5px;
            vertical-align: middle; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .post-del-btn { 
            color: var(--disagree-color); background: rgba(255, 23, 68, 0.1); 
            border: 1px solid var(--disagree-color); border-radius: 5px;
            font-size: 14px; cursor: pointer; padding: 5px 10px; 
            position: absolute; top: 15px; right: 15px;
        }
        .ban-btn {
            color: #ffcc00; background: rgba(255, 204, 0, 0.1);
            border: 1px solid #ffcc00; border-radius: 5px;
            font-size: 10px; cursor: pointer; padding: 3px 6px;
            margin-left: 5px;
        }

        .post-title { font-size: 17px; color: var(--accent); margin: 8px 0; font-weight: bold; }
        .post-body { font-size: 14px; line-height: 1.5; color: #ddd; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word;}

        .social-actions { 
            display: flex; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; 
        }
        .action-btn { 
            flex: 1; background: rgba(255,255,255,0.05); border: none; color: var(--text-muted); 
            padding: 8px; border-radius: 20px; font-size: 12px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; 
        }
        .action-btn:hover { background: rgba(255,255,255,0.15); }
        .action-btn.liked { color: var(--like-color); background: rgba(0, 230, 118, 0.1); font-weight: bold; }
        .action-btn.disagreed { color: var(--disagree-color); background: rgba(255, 23, 68, 0.1); font-weight: bold; }

        .comments-section { 
            display: none; margin-top: 15px; padding-top: 10px; 
            border-top: 1px dashed rgba(255,255,255,0.1); animation: fadeIn 0.3s;
        }
        .comment-item { 
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; 
            margin-bottom: 8px; font-size: 13px; border-left: 2px solid var(--ui-border);
        }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .comment-author { color: var(--accent); font-weight: bold; font-size: 12px; }
        .comment-text { color: var(--text-main); line-height: 1.3; }

        /* --- UI COMPONENTES GENERALES --- */
        .glass-panel {
            background: var(--ui-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--ui-border); border-radius: 16px; padding: 25px; margin: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .theme-card {
            background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .theme-card.active { border-color: var(--accent); background: rgba(0,0,0,0.4); box-shadow: 0 0 15px var(--accent-glow); }
        .theme-preview-circle { width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 10px; border: 2px solid rgba(255,255,255,0.2); }
        .theme-name { font-size: 11px; font-weight: bold; color: var(--text-muted); }

        .shelf-wood {
            grid-column: 1 / -1; height: 8px;
            background: linear-gradient(to bottom, #eeeeee 0%, #cccccc 50%, #999999 100%);
            margin-top: -12px; margin-bottom: 45px; 
            border-radius: 2px 2px 5px 5px; transform: scaleX(1.02); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.9), 0 -1px 0 rgba(255,255,255,0.6) inset; 
            z-index: 20; position: relative; 
            border-top: 1px solid rgba(255,255,255,0.8);
        }

        .input-box {
            width: 100%; padding: 15px; margin: 10px 0 20px 0; background: rgba(0,0,0,0.3);
            border: 1px solid var(--ui-border); border-radius: 8px; color: var(--text-main); box-sizing: border-box;
        }
        .btn-neon {
            background: transparent; color: var(--accent); border: 2px solid var(--accent);
            padding: 12px; width: 100%; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 5px var(--accent-glow); transition: 0.3s;
        }
        .btn-neon:hover { background: var(--accent); color: var(--bg-wall); box-shadow: 0 0 20px var(--accent-glow); }
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        
        .btn-google {
            background: white; color: #333; border: none; padding: 12px; width: 100%; 
            border-radius: 30px; font-weight: bold; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; gap: 10px; margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .app-header {
            background: var(--header-bg); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--ui-border); transition: 0.5s;
        }
        .header-top { display: flex; align-items: center; padding: 15px; justify-content: space-between; }
        .search-box {
            background: rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 15px;
            flex-grow: 1; margin: 0 15px; display: flex; align-items: center;
        }
        .search-box input { background: transparent; border: none; width: 100%; outline: none; color: white; }
        
        /* Bot√≥n Notas Redise√±ado (Header) */
        .notes-header-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--accent); 
            color: var(--accent); border-radius: 20px; padding: 8px 15px; 
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            font-size: 11px; font-weight: bold; transition: 0.3s; white-space: nowrap;
        }
        .notes-header-btn:hover { background: var(--accent); color: #000; }

        .nav-tabs { display: flex; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--ui-border); }
        .nav-tabs button {
            flex: 1; padding: 15px 0; background: none; border: none; font-size: 11px; font-weight: 700;
            color: var(--text-muted); text-transform: uppercase; border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .nav-tabs button.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        .page-section { display: none; padding-top: 15px; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        .shelf-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0px 10px; padding: 15px 10px 70px 10px; overflow-y: auto; }
        
        .book-wrapper { 
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; 
            height: 160px; perspective: 600px; z-index: 10; padding-bottom: 12px; 
        }
        
        .book-title { display: none; }

        .book-cover {
            height: 120px !important; width: auto !important; max-width: 80px;           
            aspect-ratio: 2/3; object-fit: cover; border-radius: 2px;
            transform: rotateY(-12deg); transform-origin: left center;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.6); border-left: 2px solid rgba(255,255,255,0.3);
            background: #333; margin-bottom: 2px; transition: 0.3s; margin: 0 auto; 
        }
        .book-cover.generated {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; text-align: center; font-size: 10px; color: white;
            box-sizing: border-box; background: linear-gradient(45deg, #333, #555);
        }
        .book-wrapper:active .book-cover { transform: rotateY(0deg) scale(0.95); }

        .admin-controls {
            position: absolute; top: -15px; right: -10px; z-index: 50; display: flex; gap: 5px;
        }
        .icon-btn {
            width: 26px; height: 26px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            border: 1px solid white; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        .delete-btn { background: #ff1744; color: white; }
        .edit-btn { background: #ffea00; color: black; }

        .video-card {
            background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;
            margin-bottom: 20px; border: 1px solid var(--ui-border); display: flex; flex-direction: column; position: relative;
        }
        .video-thumb {
            width: 100%; height: 180px; object-fit: cover; background: #000;
            display: block; cursor: pointer;
        }
        .video-info { padding: 15px; }
        .video-title { font-size: 14px; font-weight: bold; color: var(--accent); margin-bottom: 5px; }
        .video-desc { font-size: 12px; color: var(--text-muted); line-height: 1.4; }

        #versiculo-container {
            position: relative; min-height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px; text-align: center;
        }
        .leaf {
            position: absolute; top: -30px; width: 25px; height: 25px; font-size: 20px; color: rgba(255, 165, 0, 0.7);
            z-index: 15; pointer-events: none; animation: fall linear infinite;
        }
        .leaf::after { content: 'üçÇ'; } 
        @keyframes fall {
            0% { transform: translateY(-30px) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) translateX(50px) rotate(360deg); opacity: 0; }
        }

        #videos { position: relative; overflow: hidden; min-height: 100vh; }
        .rain {
            position: absolute; top: -20px; width: 2px; height: 15px;
            background: var(--accent); opacity: 0.6; z-index: 5; pointer-events: none;
            animation: fallRain linear infinite;
        }
        @keyframes fallRain { to { transform: translateY(100vh); } }

        .verse-card-display {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 30px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-top: 40px; z-index: 10;
            max-width: 90%; width: 100%; box-sizing: border-box;
        }
        .verse-img {
            width: 100%; border-radius: 10px; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); object-fit: cover;
        }

        /* MODALS (GENERAL) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9000; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #222; border: 1px solid var(--ui-border); border-radius: 16px;
            padding: 30px; text-align: center; max-width: 300px; width:90%; animation: popIn 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Bot√≥n Notas Intro */
        .intro-note-btn { 
            background: rgba(0, 229, 255, 0.05); border: 1px solid var(--accent); 
            color: var(--text-main); width: 100%; padding: 12px; border-radius: 8px; 
            margin-bottom: 20px; display: flex; align-items: center; justify-content: center; 
            gap: 10px; cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .drawer {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: var(--bg-wall); color: var(--text-main); z-index: 2000; transition: 0.3s;
            box-shadow: 5px 0 30px rgba(0,0,0,0.9); display: flex; flex-direction: column;
            border-right: 1px solid var(--ui-border);
        }
        .drawer.open { left: 0; }
        .drawer-header { background: rgba(0,0,0,0.2); padding: 30px 20px; border-bottom: 1px solid var(--ui-border); }
        .drawer-item { padding: 18px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 15px; align-items: center; color: var(--text-muted); }
        .drawer-item svg { fill: var(--text-muted); } .drawer-item:active svg { fill: var(--accent); }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--header-bg); height: 60px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--ui-border); z-index: 500; backdrop-filter: blur(10px);
        }
        .nav-item { background: none; border: none; font-size: 10px; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; }
        .nav-item.active-btn { color: var(--accent); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 3px; fill: currentColor; }
        
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1500; backdrop-filter: blur(5px); }
        .icon { width: 20px; height: 20px; fill: currentColor; }
        .fav-heart { position: absolute; top: 5px; right: 5px; z-index: 30; fill: rgba(255,255,255,0.7); filter: drop-shadow(0 2px 2px black); }
        .fav-heart.active { fill: #ff0055; filter: drop-shadow(0 0 8px #ff0055); }

    </style>
</head>
<body>

<div id="overlay" class="overlay" onclick="toggleDrawer()"></div>

<button class="fab-btn" onclick="document.getElementById('notes-modal').style.display='flex'">
    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
</button>
<div id="notes-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0; font-family:'Courier New', monospace;">üìù BLOC DE NOTAS</h3>
        <p style="font-size:10px; color:var(--text-muted); margin-bottom:5px; text-transform:uppercase; letter-spacing:1px;">Guardado Localmente</p>
        <textarea id="user-notes" class="notes-textarea" rows="10" placeholder="Escribe tus pensamientos, vers√≠culos o ideas..."></textarea>
        <div style="display:flex; gap:10px; margin-top:15px; justify-content:flex-end;">
            <button class="btn-neon" style="border-color:rgba(255,255,255,0.2); color:#aaa; font-size:11px; padding:8px 15px;" onclick="document.getElementById('notes-modal').style.display='none'">CERRAR</button>
            <button class="btn-neon" style="font-size:11px; padding:8px 15px; background:var(--accent-glow);" onclick="saveNotes()">GUARDAR</button>
        </div>
    </div>
</div>

<div id="profile-setup-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-size:40px; margin-bottom:10px">üëã</div>
        <h3 style="color:var(--accent); margin:0 0 5px 0;">¬°Bienvenido/a!</h3>
        <p style="color:var(--text-main); font-size:13px; margin-bottom:20px;">Configura tu perfil para la comunidad.</p>
        
        <label style="font-size:11px; font-weight:bold; color:var(--text-muted); display:block; text-align:left; margin-bottom:5px;">TU APODO / NICKNAME</label>
        <input type="text" id="profile-nick" class="input-box" style="margin-top:0; text-align:center;" placeholder="Ej: Juan_316">
        
        <label style="font-size:11px; font-weight:bold; color:var(--text-muted); display:block; text-align:left; margin-bottom:10px;">ELIGE TU AVATAR</label>
        <div class="avatar-grid">
            <div class="avatar-option" onclick="selectAvatar('üë®', this)">üë®</div>
            <div class="avatar-option" onclick="selectAvatar('üë©', this)">üë©</div>
            <div class="avatar-option" onclick="selectAvatar('üë¶', this)">üë¶</div>
            <div class="avatar-option" onclick="selectAvatar('üëß', this)">üëß</div>
            <div class="avatar-option" onclick="selectAvatar('üë§', this)">üë§</div>
        </div>
        <input type="hidden" id="selected-avatar-val">

        <div class="terms-container">
            <input type="checkbox" id="terms-check" onchange="toggleSaveBtn()">
            <span>Acepto los <span class="terms-link" onclick="showTerms()">T√©rminos y Condiciones</span> de la comunidad.</span>
        </div>

        <button id="btn-save-profile" class="btn-neon" onclick="saveUserProfile()" disabled>GUARDAR Y CONTINUAR</button>
    </div>
</div>

<div id="terms-modal" class="modal-overlay" style="z-index:10001;">
    <div class="modal-content" style="text-align:left; max-height:60vh; overflow-y:auto;">
        <h4 style="color:var(--accent); margin-top:0;">üìú Reglas de Convivencia</h4>
        <ul style="font-size:12px; color:var(--text-muted); padding-left:15px; line-height:1.6;">
            <li>Respeto mutuo y lenguaje apropiado.</li>
            <li>No publicar contenido ofensivo o spam.</li>
            <li>El Admin puede bloquear usuarios conflictivos.</li>
            <li>La app se reserva el derecho de admisi√≥n.</li>
        </ul>
        <button class="btn-neon" onclick="document.getElementById('terms-modal').style.display='none'">ENTENDIDO</button>
    </div>
</div>

<div id="update-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-size:40px; margin-bottom:10px">üöÄ</div>
        <h3 id="upd-title" style="color:var(--accent); margin:0 0 10px 0;">Nueva Versi√≥n</h3>
        <p id="upd-msg" style="color:var(--text-main); font-size:14px; margin-bottom:20px;">Hay una actualizaci√≥n disponible.</p>
        <button id="upd-btn" class="btn-neon">DESCARGAR AHORA</button>
        <div style="margin-top:15px;">
            <button onclick="document.getElementById('update-modal').style.display='none'" style="background:none; border:none; color:var(--text-muted); font-size:12px; cursor:pointer;">Quiz√°s luego</button>
        </div>
    </div>
</div>

<div id="success-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-size:40px; margin-bottom:10px">‚ú®</div>
        <h3 id="modal-title" style="color:var(--text-main); margin:0 0 10px 0;">¬°√âxito!</h3>
        <p id="modal-msg" style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">Operaci√≥n realizada.</p>
        <button class="btn-neon" onclick="closeModal()">CERRAR</button>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0">‚úèÔ∏è Editar</h3>
        <input type="hidden" id="edit-id">
        <input type="hidden" id="edit-collection">
        
        <label style="font-size:10px; color:var(--text-muted); display:block; text-align:left">T√≠tulo</label>
        <input type="text" id="edit-title-input" class="input-box" style="margin-bottom:10px">
        
        <label style="font-size:10px; color:var(--text-muted); display:block; text-align:left">Descripci√≥n / Autor</label>
        <textarea id="edit-desc-input" class="input-box" rows="3" style="margin-bottom:10px"></textarea>
        
        <label style="font-size:10px; color:var(--text-muted); display:block; text-align:left">Link / URL</label>
        <input type="text" id="edit-link-input" class="input-box" style="margin-bottom:10px">
        
        <label style="font-size:10px; color:var(--text-muted); display:block; text-align:left">Imagen Portada (URL)</label>
        <input type="text" id="edit-img-input" class="input-box" style="margin-bottom:20px">
        
        <div style="display:flex; gap:10px;">
            <button class="btn-neon" style="border-color:#555; color:#aaa" onclick="document.getElementById('edit-modal').style.display='none'">CANCELAR</button>
            <button class="btn-neon" onclick="saveEdit()">GUARDAR</button>
        </div>
    </div>
</div>

<div id="drawer" class="drawer">
    <div class="drawer-header">
        <h2 style="margin:0; color:var(--accent); text-shadow:0 0 10px var(--accent-glow)">Mi Biblioteca</h2>
        <small style="color:var(--text-muted)">La verdad de Dios, al alcance de todos</small>
    </div>
    <div style="flex:1; overflow-y:auto">
        <div class="drawer-item" onclick="navigate('recientes'); toggleDrawer()"><svg class="icon"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> Inicio</div>
        <div class="drawer-item" onclick="navigate('configuracion'); toggleDrawer()"><svg class="icon"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg> Personalizaci√≥n</div>
        <div class="drawer-item" onclick="navigate('publicar'); toggleDrawer()"><svg class="icon"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg> Publicar</div>
        <div class="drawer-item" onclick="navigate('donacion'); toggleDrawer()"><svg class="icon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> Donaci√≥n</div>
        <div class="drawer-item" onclick="navigate('pedir'); toggleDrawer()"><svg class="icon"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg> Pedir Libro</div>
        <div class="drawer-item" onclick="navigate('ayuda'); toggleDrawer()"><svg class="icon"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg> Ayuda y Reportes</div>
    </div>
</div>
<header class="app-header">
    <div class="header-top">
        <div class="menu-btn" onclick="toggleDrawer()" style="color:var(--text-main); font-size:24px; cursor:pointer; margin-right:10px;">‚ò∞</div>
        
        <div class="search-box">
            <span style="color:#777">üîç</span> 
            <input type="text" id="searchInput" placeholder="Buscar libro..." onkeyup="searchBooks(this.value)">
        </div>

        <button class="notes-header-btn" onclick="document.getElementById('notes-modal').style.display='flex'">
            üìù Notas
        </button>
    </div>
    <nav class="nav-tabs">
        <button id="tab-recientes" class="active" onclick="navigate('recientes')">Inicio</button>
        <button id="tab-nube" onclick="navigate('nube')">Nube</button>
        <button id="tab-versiculo" onclick="navigate('versiculo')">Vers√≠culo</button>
        <button id="tab-videos" onclick="navigate('videos')">Videos</button>
        <button id="tab-debate" onclick="navigate('debate')">Comunidad</button>
    </nav>
</header>
<main id="main-content">

    <div id="recientes" class="page-section active">
        <div style="padding: 10px 10px 0 10px;">
            <button class="intro-note-btn" onclick="document.getElementById('notes-modal').style.display='flex'">
                üìù Ver Mis Notas Personales
            </button>
        </div>
        <div class="shelf-grid" id="grid-recientes"></div>
    </div>

    <div id="nube" class="page-section">
        <div class="shelf-grid" id="grid-nube"></div>
    </div>

    <div id="versiculo" class="page-section">
        <div id="versiculo-container">
            <div id="admin-verse-form" style="display:none; width:100%; margin-bottom:20px; background:rgba(0,0,0,0.5); padding:15px; border-radius:10px;">
                <h4 style="margin:0 0 10px 0; color:var(--accent)">Admin: Vers√≠culo Diario</h4>
                <input type="text" id="verseTitle" class="input-box" placeholder="T√≠tulo (ej: La Paz)" style="margin-bottom:5px">
                <textarea id="verseText" class="input-box" rows="3" placeholder="Texto o descripci√≥n del vers√≠culo..." style="margin-bottom:5px"></textarea>
                <input type="url" id="verseImgUrl" class="input-box" placeholder="URL de la imagen" style="margin-bottom:5px">
                <button class="btn-neon" onclick="updateDailyVerse()">PUBLICAR</button>
                <button class="btn-neon" onclick="deleteDailyVerse()" style="margin-top:10px; background:red; border-color:red; color:white;">ELIMINAR VERS√çCULO</button>
            </div>

            <div class="verse-card-display">
                <img id="displayVerseImg" class="verse-img" src="" style="display:none">
                <h2 id="displayVerseTitle" style="color:var(--accent); margin-top:0;"></h2>
                <p id="displayVerseText" style="color:#fff; font-family:'Georgia', serif; font-style:italic; font-size:16px; line-height:1.5;"></p>
                <p id="verseDate" style="color:var(--text-muted); font-size:12px; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px"></p>
            </div>
        </div>
    </div>

    <div id="debate" class="page-section">
        <div style="max-width: 600px; margin: 0 auto; padding: 10px;">
            
            <div style="text-align:center;">
                <div class="online-counter">
                    <div class="online-dot"></div>
                    <span id="live-user-count">Calculando...</span> usuarios leyendo ahora
                </div>
            </div>

            <div id="feed-login-prompt" style="text-align:center; padding:30px; background:var(--ui-bg); border-radius:12px; margin-bottom:20px; border:1px solid var(--ui-border);">
                <div style="font-size:50px; margin-bottom:10px">üë•</div>
                <h3 style="color:var(--accent); margin-top:0">√önete a la Comunidad</h3>
                <p style="color:var(--text-muted); font-size:13px;">Inicia sesi√≥n para publicar temas, dar likes y comentar.</p>
                <button class="btn-google" onclick="loginWithGoogle()" style="margin:20px auto; width:80%;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                    Iniciar Sesi√≥n con Google
                </button>
            </div>

            <div id="create-post-container" class="create-post-card" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="user-avatar-display" class="post-avatar">?</span>
                        <span id="user-name-display" style="font-weight:bold; color:var(--text-main); font-size:14px;">Usuario</span>
                    </div>
                    <button id="btn-logout-feed" onclick="logout()" style="background:none; border:none; color:var(--text-muted); text-decoration:underline; font-size:11px; cursor:pointer;">Cerrar sesi√≥n</button>
                </div>
                
                <input type="text" id="postTitle" class="input-box" placeholder="T√≠tulo de tu tema..." style="margin-bottom:8px; padding:10px;">
                <textarea id="postBody" class="input-box" rows="3" placeholder="Comparte una reflexi√≥n o pregunta..." style="margin-bottom:10px; padding:10px;"></textarea>
                <button class="btn-neon" onclick="createPost()">PUBLICAR</button>
            </div>

            <div id="feed-container" class="social-feed">
                <p style="text-align:center; color:#666; padding:20px;">Cargando...</p>
            </div>
        </div>
    </div>
    <div id="videos" class="page-section">
        <div id="video-upload-form" style="display:none; margin:15px; padding:15px; background:rgba(0,0,0,0.5); border-radius:10px; z-index:20; position:relative;">
            <h4 style="margin:0 0 10px 0; color:var(--accent)">üé• Compartir Video (YouTube)</h4>
            <input type="text" id="vidTitle" class="input-box" placeholder="T√≠tulo del Video">
            <input type="text" id="vidDesc" class="input-box" placeholder="Descripci√≥n breve">
            <input type="url" id="vidUrl" class="input-box" placeholder="Link de YouTube">
            <button class="btn-neon" onclick="uploadVideo()">AGREGAR VIDEO</button>
        </div>
        
        <div id="btn-show-video-form" style="padding:15px; text-align:center; display:none;">
            <button class="btn-neon" onclick="toggleVideoForm()" style="font-size:12px; padding:8px 20px;">+ SUBIR VIDEO</button>
        </div>

        <div id="video-list" style="padding:15px; padding-bottom:80px; z-index:10; position:relative;"></div>
    </div>
    <div id="favoritos" class="page-section">
        <h2 style="text-align:center;color:var(--text-main);text-shadow:0 0 10px var(--accent);">Mis Favoritos ‚ù§Ô∏è</h2>
        <div class="shelf-grid" id="grid-favoritos"></div>
    </div>

    <div id="configuracion" class="page-section">
        <div class="glass-panel">
            <h2 style="margin-top:0; color:var(--accent); text-align:center"> Atm√≥sfera de Lectura</h2>
            <div class="theme-grid">
                <div class="theme-card active" onclick="changeTheme('default', this)"><div class="theme-preview-circle" style="background:#1e1e24; border-color:#555"></div><div class="theme-name">Dark Slate</div></div>
                <div class="theme-card" onclick="changeTheme('orange', this)"><div class="theme-preview-circle" style="background:#1a1008; border-color:#ff6d00"></div><div class="theme-name">Energetic Orange</div></div>
                <div class="theme-card" onclick="changeTheme('silver', this)"><div class="theme-preview-circle" style="background:#212121; border-color:#b0bec5"></div><div class="theme-name">Sleek Silver</div></div>
                <div class="theme-card" onclick="changeTheme('red', this)"><div class="theme-preview-circle" style="background:#1a0505; border-color:#ff1744"></div><div class="theme-name">Crimson Red</div></div>
                <div class="theme-card" onclick="changeTheme('blue', this)"><div class="theme-preview-circle" style="background:#050a1a; border-color:#2979ff"></div><div class="theme-name">Royal Blue</div></div>
                <div class="theme-card" onclick="changeTheme('green', this)"><div class="theme-preview-circle" style="background:#051a0a; border-color:#00e676;"></div><div class="theme-name">Emerald Green</div></div>
                <div class="theme-card" onclick="changeTheme('purple', this)"><div class="theme-preview-circle" style="background:#12051a; border-color:#d500f9;"></div><div class="theme-name">Deep Purple</div></div>
                <div class="theme-card" onclick="changeTheme('gold', this)"><div class="theme-preview-circle" style="background:#141005; border-color:#ffca28;"></div><div class="theme-name">Luxury Gold</div></div>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button onclick="toggleAdminMode()" style="background:none; border:1px solid #444; padding:5px 15px; border-radius:15px; color:var(--text-muted); font-size:10px; cursor:pointer;">Admin Mode</button>
            </div>

            <div id="admin-update-form" style="display:none; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <h3 style="color:var(--accent); text-align:center; margin-bottom:5px;">üîî Configurar Alerta</h3>
                <label style="font-size:10px; color:var(--accent);">ESTADO DEL AVISO</label>
                <select id="updStatus" class="input-box" style="padding:10px; height:auto; margin-bottom:10px; background:#111;">
                    <option value="off">üî¥ Desactivado</option>
                    <option value="on">üü¢ Activado (Visible al entrar)</option>
                </select>
                <label style="font-size:10px; color:var(--accent);">T√çTULO DE LA VENTANA</label>
                <input type="text" id="updTitleInput" class="input-box" placeholder="Ej: ¬°Nueva Versi√≥n Disponible!">
                <label style="font-size:10px; color:var(--accent);">MENSAJE / TEXTO</label>
                <textarea id="updMsgInput" class="input-box" rows="2" placeholder="Ej: Descarga la nueva..."></textarea>
                <label style="font-size:10px; color:var(--accent);">LINK DE DESCARGA</label>
                <input type="text" id="updLinkInput" class="input-box" placeholder="https://...">
                <button class="btn-neon" onclick="saveUpdateConfig()">GUARDAR CONFIGURACI√ìN</button>
            </div>
        </div>
    </div>

    <div id="publicar" class="page-section">
        <div class="glass-panel">
            <h2 style="color:var(--accent);margin-top:0;"> Subir a la Nube</h2>
            <p style="font-size:11px; color:var(--text-muted); margin-bottom:15px">Agrega un libro a la base de datos p√∫blica.</p>
            <form id="publishForm" onsubmit="handleGenericForm(event, '¬°Publicado!', 'El libro est√° disponible para todos.')">
                <label style="font-size:11px; font-weight:bold; color:var(--text-muted)">T√çTULO</label>
                <input type="text" id="pubTitle" class="input-box" required placeholder="T√≠tulo del libro">
                <label style="font-size:11px; font-weight:bold; color:var(--text-muted)">AUTOR</label>
                <input type="text" id="pubAuthor" class="input-box" required placeholder="Nombre del Autor">
                <label style="font-size:11px; font-weight:bold; color:var(--text-muted)">LINK PDF (Google Drive/Dropbox)</label>
                <input type="url" id="pubLink" class="input-box" required placeholder="https://...">
                <label style="font-size:11px; font-weight:bold; color:var(--text-muted)">LINK PORTADA (Opcional)</label>
                <input type="url" id="pubCover" class="input-box" placeholder="https://... (Si est√° vac√≠o, se genera sola)">
                <button type="button" class="btn-neon filled" onclick="uploadBookToCloud()">PUBLICAR AHORA</button>
            </form>
        </div>
    </div>

    <div id="donacion" class="page-section">
        <div class="glass-panel" style="text-align:center">
            <h2 style="color:#ffcc00; text-shadow:0 0 15px rgba(255,215,0,0.6)">Donaciones</h2>
            <p style="font-size:14px; color:var(--text-muted)">Tu apoyo mantiene los servidores activos y la verdad al alcance de todos.</p>
            <div style="font-size:50px; margin:20px 0; animation: float 3s ease-in-out infinite;">ü§ù</div>
            <button class="btn-neon" style="background:rgba(255,204,0,0.1); border-color:#ffcc00; color:#ffcc00" onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=5YA3A93HWYMRA','_blank')">‚ù§Ô∏è Donar con PayPal</button>
        </div>
    </div>

    <div id="pedir" class="page-section">
        <div class="glass-panel">
            <h2 style="color:var(--accent)">Solicitar Libro</h2>
            <p style="font-size:12px; color:var(--text-muted)">Haremos lo posible por conseguirlo.</p>
            <form action="https://formsubmit.co/mancillacanales992@gmail.com" method="POST" onsubmit="handleGenericForm(event, 'Solicitud Enviada', '¬°Gracias! Buscaremos el libro.')">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_subject" value="Pedido de Libro">
                <input type="text" name="libro" class="input-box" placeholder="Nombre del Libro" required>
                <input type="text" name="autor" class="input-box" placeholder="Autor (Opcional)">
                <button type="submit" class="btn-neon">ENVIAR PEDIDO</button>
            </form>
        </div>
    </div>

    <div id="ayuda" class="page-section">
        <div class="glass-panel">
            <h2 style="border-bottom: 1px solid var(--accent); padding-bottom:10px; color:var(--accent); letter-spacing:1px; font-size:18px; text-align:center; width:100%">PREGUNTAS FRECUENTES</h2>
            
            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº ¬øEsta biblioteca es totalmente gratuita?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    S√≠, el acceso a la lectura y descarga de materiales en PDF y ePub es gratuito. Nuestro prop√≥sito es facilitar el acceso a la literatura cristiana para edificaci√≥n de todos. Sin embargo, creemos firmemente que "el obrero es digno de su salario" (1 Timoteo 5:18). Por ello, recomendamos encarecidamente que, si tienes la solvencia econ√≥mica, compres el libro directamente a su autor o en su tienda oficial para bendecir su ministerio.
                </p>
            </details>

            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº ¬øPor qu√© hay publicidad en la aplicaci√≥n y el sitio web?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    La publicidad nos permite mantener la plataforma en l√≠nea, cubrir los costos de servidores, almacenamiento y mantenimiento t√©cnico para que el servicio siga estando disponible para todos, especialmente para aquellos que no tienen recursos para adquirir libros.
                </p>
            </details>

            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº Si hago una donaci√≥n, ¬øse elimina la publicidad?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    No. Hemos decidido mantener la publicidad general para sostener la infraestructura t√©cnica b√°sica. Las donaciones tienen un prop√≥sito diferente y m√°s noble: se utilizan para apoyar econ√≥micamente a los autores independientes dentro de nuestra plataforma y para adquirir legalmente nuevos libros y licencias para ampliar la biblioteca comunitaria.
                </p>
            </details>

            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº ¬øA d√≥nde va el dinero de los ingresos y donaciones?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    Operamos bajo un modelo de transparencia y mayordom√≠a. Los fondos se distribuyen de la siguiente manera:<br>
                    ‚Ä¢ Mantenimiento t√©cnico de la web y la app.<br>
                    ‚Ä¢ Un porcentaje se destina como beneficio directo a los autores asociados.<br>
                    ‚Ä¢ Compra de nuevo material bibliogr√°fico para ponerlo a disposici√≥n de los usuarios.
                </p>
            </details>

            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº ¬øPuedo importar mis propios archivos a la aplicaci√≥n?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    S√≠. Nuestra app cuenta con una funci√≥n de "Importar Archivos" que te permite cargar tus propios PDF y ePubs para que puedas usar nuestra plataforma como tu lector personal y tener toda tu biblioteca organizada en un solo lugar.
                </p>
            </details>

            <details style="margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px">
                <summary style="font-weight:bold; cursor:pointer; color:var(--text-main); list-style:none">‚ñº ¬øQu√© hago si encuentro un libro que infringe derechos de autor?</summary>
                <p style="font-size:13px; margin-top:10px; line-height:1.6; color:var(--text-muted); padding-left:15px">
                    Respetamos profundamente la propiedad intelectual y el trabajo de los escritores cristianos. Si eres el autor o representante legal de una obra y deseas que sea retirada o gestionar sus derechos, por favor utiliza nuestro Formulario de Reporte. Atenderemos tu solicitud a la brevedad posible para actuar conforme a la ley y a la √©tica cristiana.
                </p>
            </details>

            <br>
            <h2 style="border-bottom: 1px solid var(--accent); padding-bottom:10px; color:var(--accent); font-size:16px;"> REPORTE Y GESTI√ìN</h2>
            <p style="font-size:11px; margin-bottom:20px; color:var(--text-muted); text-align:center">Para errores t√©cnicos, enlaces rotos o gesti√≥n de derechos de autor.</p>

            <form action="https://formsubmit.co/mancillacanales992@gmail.com" method="POST" onsubmit="handleGenericForm(event, 'Reporte Enviado', 'Revisaremos tu caso a la brevedad.')">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_subject" value="REPORTE URGENTE - APP BIBLIOTECA">
                
                <div style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px">1. DATOS DE CONTACTO</div>
                <input type="text" name="nombre" class="input-box" placeholder="Nombre Completo" required>
                <input type="email" name="email" class="input-box" placeholder="Email" required>

                <div style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px">2. DETALLES</div>
                <input type="text" name="recurso" class="input-box" placeholder="T√≠tulo del Libro / URL" required>

                <div style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px">3. MOTIVO</div>
                <select name="motivo" class="input-box" style="background:#222; color:white">
                    <option>Infracci√≥n Derechos de Autor</option>
                    <option>Archivo Da√±ado</option>
                    <option>Informaci√≥n Incorrecta</option>
                    <option>Contenido Inapropiado</option>
                    <option>Otro</option>
                </select>

                <div style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:15px">4. MENSAJE / PRUEBAS</div>
                <textarea name="mensaje" class="input-box" rows="4" placeholder="Detalles adicionales..."></textarea>

                <label style="display:flex; gap:10px; font-size:11px; color:var(--text-muted); align-items:flex-start; margin-top:10px">
                    <input type="checkbox" required>
                    <span>Declaro que la informaci√≥n es ver√≠dica. Reportes falsos perjudican a la comunidad.</span>
                </label>

                <button type="submit" class="btn-neon filled" style="margin-top:20px">ENVIAR REPORTE</button>
            </form>
        </div>
    </div>

</main>

<footer class="bottom-bar">
    <button class="nav-item" onclick="navigate('recientes')">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> Inicio
    </button>
    <button class="nav-item" onclick="navigate('favoritos')">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> Favoritos
    </button>
    <button class="nav-item" onclick="window.open('https://youtube.com/@verdadesenm?si=JgKmzs7HcQtSTBVg','_blank')">
        <svg viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg> Canal
    </button>
    <button class="nav-item" onclick="navigate('ayuda')">
        <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg> Ayuda
    </button>
</footer>
<script type="module">
    /* --- 1. CONFIGURACI√ìN DE FIREBASE --- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, setDoc, getDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, limit, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDLyZS-alUh5DOtBBtts-8D_hza-n71Y3I",
        authDomain: "biblioteca-cristiano.firebaseapp.com",
        projectId: "biblioteca-cristiano",
        storageBucket: "biblioteca-cristiano.firebasestorage.app",
        messagingSenderId: "737226922744",
        appId: "1:737226922744:web:8746608081fef3355ff90d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); 

    /* --- 1.1 MANEJO RETORNO LOGIN (M√ìVILES) --- */
    getRedirectResult(auth)
        .then((result) => {
            if (result) console.log("Regreso de Google exitoso.");
        })
        .catch((error) => {
            if (error.code !== 'auth/popup-closed-by-user') console.error("Error Login:", error);
        });

    /* --- 2. ESTADO GLOBAL --- */
    let cloudBooks = []; 
    let youtubeVideos = [];
    let favorites = JSON.parse(localStorage.getItem('my_fav_books')) || [];
    let updateConfig = { status: 'off', title: '', msg: '', link: '' }; 
    let isAdminMode = localStorage.getItem('is_admin_active') === 'true'; 
    let hasShownUpdate = false; 
    let leavesInterval, rainInterval; 
    let robotInterval; // Variable para el robot de usuarios
    
    // VARIABLES DE USUARIO
    window.currentUser = null;       // Objeto de Auth de Google
    window.currentUserProfile = null; // Objeto de Firestore (Nick + Avatar + Estado)

    /* --- 3. LISTENERS BASE DE DATOS (CONTENIDO) --- */
    
    // Libros
    onSnapshot(query(collection(db, "libros"), orderBy("timestamp", "desc")), (snapshot) => {
        cloudBooks = [];
        snapshot.forEach((doc) => cloudBooks.push({ id: doc.id, ...doc.data(), type: 'cloud' }));
        refreshActiveViews();
    });

    // Videos
    onSnapshot(query(collection(db, "videos"), orderBy("timestamp", "desc")), (snapshot) => {
        youtubeVideos = [];
        snapshot.forEach((doc) => youtubeVideos.push({ id: doc.id, ...doc.data() }));
        refreshActiveViews();
    });

    // Vers√≠culo
    onSnapshot(doc(db, "configuracion", "versiculo_diario"), (docSnap) => {
        renderVerse(docSnap.exists() ? docSnap.data() : null);
    });

    // Configuraci√≥n Alerta (ACTUALIZACIONES)
    onSnapshot(doc(db, "configuracion", "alerta_update"), (docSnap) => {
        if (docSnap.exists()) {
            updateConfig = docSnap.data();
            // Mostrar modal solo si est√° activo y no se ha mostrado en esta sesi√≥n
            if (updateConfig.status === 'on' && !hasShownUpdate) {
                document.getElementById('upd-title').innerText = updateConfig.title || "Actualizaci√≥n";
                document.getElementById('upd-msg').innerText = updateConfig.msg || "Nueva versi√≥n disponible.";
                const btn = document.getElementById('upd-btn');
                btn.onclick = () => window.open(updateConfig.link, '_blank');
                document.getElementById('update-modal').style.display = 'flex';
                hasShownUpdate = true;
            }
            // Llenar formulario Admin si est√° activo
            if (isAdminMode) {
                document.getElementById('updStatus').value = updateConfig.status;
                document.getElementById('updTitleInput').value = updateConfig.title;
                document.getElementById('updMsgInput').value = updateConfig.msg;
                document.getElementById('updLinkInput').value = updateConfig.link;
            }
        }
    });

    function refreshActiveViews() {
        if(document.getElementById('recientes').classList.contains('active')) renderLibrary('grid-recientes', cloudBooks);
        if(document.getElementById('nube').classList.contains('active')) renderLibrary('grid-nube', cloudBooks);
        if(document.getElementById('videos').classList.contains('active')) renderVideoList();
        if(document.getElementById('favoritos').classList.contains('active')) renderLibrary('grid-favoritos', favorites);
        toggleAdminForms(isAdminMode);
    }
    /* --- 4. ADMIN MODE (CONTROL TOTAL) --- */
    window.toggleAdminMode = function() {
        if (isAdminMode) {
            isAdminMode = false;
            localStorage.setItem('is_admin_active', 'false');
            toggleAdminForms(false);
            alert("Modo Admin: DESACTIVADO");
            refreshActiveViews();
            updateUserUI(); // Refresco visual inmediato
            initSocialFeed(); // Quitar botones de borrar del muro
            return;
        }
        const pass = prompt("üîí Contrase√±a Admin:");
        if (pass === 'admin123') { 
            isAdminMode = true;
            localStorage.setItem('is_admin_active', 'true');
            toggleAdminForms(true);
            alert("‚úÖ Modo Admin: ACTIVADO\nTienes CONTROL TOTAL.");
            refreshActiveViews();
            
            // --- CORRECCI√ìN SOLICITADA: REFRESCO INSTANT√ÅNEO ---
            updateUserUI();   // Fuerza la aparici√≥n de la caja de postear
            initSocialFeed(); // Fuerza la aparici√≥n de botones de borrar/banear
            
            // Cargar datos de update form
            if(updateConfig) {
                document.getElementById('updStatus').value = updateConfig.status || 'off';
                document.getElementById('updTitleInput').value = updateConfig.title || '';
                document.getElementById('updMsgInput').value = updateConfig.msg || '';
                document.getElementById('updLinkInput').value = updateConfig.link || '';
            }
        } else {
            alert("‚õî Contrase√±a incorrecta.");
        }
    };

    function toggleAdminForms(show) {
        const display = show ? 'block' : 'none';
        const verseForm = document.getElementById('admin-verse-form');
        const updForm = document.getElementById('admin-update-form');
        if(verseForm) verseForm.style.display = display;
        if(updForm) updForm.style.display = display;
    }

    /* --- 5. FUNCIONES CRUD GENERALES --- */
    window.saveUpdateConfig = async function() {
        const data = {
            status: document.getElementById('updStatus').value,
            title: document.getElementById('updTitleInput').value,
            msg: document.getElementById('updMsgInput').value,
            link: document.getElementById('updLinkInput').value
        };
        try { await setDoc(doc(db, "configuracion", "alerta_update"), data); showModal("Guardado", "Alerta actualizada."); } catch(e) { alert(e.message); }
    };

    window.deleteItem = async function(collectionName, id) {
        if(event) event.stopPropagation();
        if(!confirm("‚ö†Ô∏è ADMIN: ¬øELIMINAR ESTE ELEMENTO?")) return;
        try { await deleteDoc(doc(db, collectionName, id)); } catch (e) { alert("Error: " + e.message); }
    };

    window.openEditModal = function(collectionName, id) {
        if(event) event.stopPropagation();
        let item;
        if (collectionName === 'libros') {
            item = cloudBooks.find(b => b.id === id);
            document.getElementById('edit-title-input').value = item.title || "";
            document.getElementById('edit-desc-input').value = item.author || ""; 
            document.getElementById('edit-link-input').value = item.pdfLink || "";
            document.getElementById('edit-img-input').value = item.cover || "";
        } else {
            item = youtubeVideos.find(v => v.id === id);
            document.getElementById('edit-title-input').value = item.title || "";
            document.getElementById('edit-desc-input').value = item.desc || ""; 
            document.getElementById('edit-link-input').value = item.url || "";
            document.getElementById('edit-img-input').value = ""; 
        }
        if(item) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-collection').value = collectionName;
            document.getElementById('edit-modal').style.display = 'flex';
        }
    };

    window.saveEdit = async function() {
        const id = document.getElementById('edit-id').value;
        const colName = document.getElementById('edit-collection').value;
        const updateData = { title: document.getElementById('edit-title-input').value };
        if(colName === 'libros') {
            updateData.author = document.getElementById('edit-desc-input').value;
            updateData.pdfLink = document.getElementById('edit-link-input').value;
            updateData.cover = document.getElementById('edit-img-input').value;
        } else {
            updateData.desc = document.getElementById('edit-desc-input').value;
            updateData.url = document.getElementById('edit-link-input').value;
        }
        try { await updateDoc(doc(db, colName, id), updateData); document.getElementById('edit-modal').style.display = 'none'; showModal("¬°Corregido!", "Cambios guardados."); } catch(e) { alert("Error: " + e.message); }
    };

    /* --- 6. RENDERIZADO VISUAL --- */
    window.toggleDrawer = function() { 
        const d = document.getElementById('drawer');
        d.classList.toggle('open'); 
        document.getElementById('overlay').style.display = d.classList.contains('open') ? 'block' : 'none'; 
    };

    window.navigate = function(id) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        
        const btnMap = {'recientes':0, 'nube':1, 'versiculo':2, 'videos':3, 'debate':4};
        const tabs = document.querySelectorAll('.nav-tabs button');
        if(btnMap[id] !== undefined) tabs[btnMap[id]].classList.add('active');
        
        refreshActiveViews();
        
        // EFECTOS Y ROBOT
        if(id === 'videos') {
            startRain(); 
            updateVideoUploadUI();
        } else {
            stopRain();
        }

        if(id === 'debate') {
            startUserCounter(); 
        } else {
            stopUserCounter();
        }

        if(id === 'versiculo') startFallingLeaves(); else stopFallingLeaves();
    }

    // ROBOT DE USUARIOS
    function startUserCounter() {
        const el = document.getElementById('live-user-count');
        if(!el) return;
        el.innerText = Math.floor(Math.random() * (12 - 4 + 1) + 4);
        
        if(robotInterval) clearInterval(robotInterval);
        robotInterval = setInterval(() => {
            const count = Math.floor(Math.random() * (15 - 4 + 1) + 4);
            el.innerText = count;
        }, 5000); 
    }
    
    function stopUserCounter() {
        if(robotInterval) clearInterval(robotInterval);
    }

    window.searchBooks = function(q) {
        const t = q.toLowerCase();
        const fBooks = cloudBooks.filter(b => b.title.toLowerCase().includes(t) || b.author.toLowerCase().includes(t));
        renderLibrary('grid-recientes', fBooks);
        renderLibrary('grid-nube', fBooks);
        if(document.getElementById('videos').classList.contains('active')) {
            renderVideoList(youtubeVideos.filter(v => v.title.toLowerCase().includes(t)));
        }
    };

    window.changeTheme = function(name, element) { 
        document.body.className = name !== 'default' ? 'theme-'+name : ''; 
        document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
        if(element) element.classList.add('active');
    };

    function renderLibrary(id, books) {
        const c = document.getElementById(id); c.innerHTML = '';
        if(!books.length) { c.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#777">Vac√≠o</p>'; return; }

        for(let i=0; i<books.length; i+=3) {
            books.slice(i, i+3).forEach(b => {
                const isFav = favorites.some(f => f.title === b.title) ? 'active' : '';
                const div = document.createElement('div'); div.className = 'book-wrapper';
                
                let coverHtml = b.cover ? `<img src="${b.cover}" class="book-cover" onerror="this.onerror=null;this.parentNode.innerHTML='<div class=\\'book-cover generated\\'><span>${b.title}</span></div>'">` : `<div class="book-cover generated" style="background:linear-gradient(135deg,${stringToColor(b.title)},#222)"><span>${b.title}</span></div>`;

                let adminBtns = '';
                if (isAdminMode && b.type === 'cloud') {
                    adminBtns = `<div class="admin-controls">
                        <div class="icon-btn edit-btn" onclick="openEditModal('libros', '${b.id}')">‚úèÔ∏è</div>
                        <div class="icon-btn delete-btn" onclick="deleteItem('libros', '${b.id}')">üóëÔ∏è</div>
                    </div>`;
                }
                
                div.innerHTML = `<div class="book-title">${b.title}</div>${adminBtns}<svg class="fav-heart ${isFav}" width="20" height="20" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>${coverHtml}`;
                div.querySelector('.fav-heart').onclick = (e) => { e.stopPropagation(); toggleFav(b, e.target.closest('.fav-heart')); };
                div.onclick = () => window.open(b.pdfLink, '_blank');
                
                c.appendChild(div);
            });
            const s = document.createElement('div'); s.className = 'shelf-wood'; c.appendChild(s);
        }
    }

    function getYoutubeId(url) {
        if(!url) return null;
        const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
    
    function renderVideoList(list = youtubeVideos) {
        const c = document.getElementById('video-list'); c.innerHTML = '';
        if(!list.length) { c.innerHTML = '<p style="text-align:center;color:#777">No hay videos</p>'; return; }
        
        list.forEach(v => {
            const vid = getYoutubeId(v.url);
            const thumb = vid ? `https://img.youtube.com/vi/${vid}/hqdefault.jpg` : 'https://via.placeholder.com/480x360?text=Video';
            const card = document.createElement('div'); card.className = 'video-card';
            
            // Botones Admin (CONTROL TOTAL)
            let adminBtns = '';
            if(isAdminMode) {
                adminBtns = `<div style="display:flex; border-top:1px solid #444; margin-top:auto;">
                    <button onclick="openEditModal('videos', '${v.id}')" style="flex:1; background:#ffea00; color:black; border:none; padding:10px; cursor:pointer; font-weight:bold;">‚úèÔ∏è EDITAR</button>
                    <button onclick="deleteItem('videos', '${v.id}')" style="flex:1; background:#ff1744; color:white; border:none; padding:10px; cursor:pointer; font-weight:bold;">üóëÔ∏è BORRAR</button>
                </div>`;
            }

            // Datos del uploader
            let uploaderHtml = '';
            let avatarDisplay = v.uploaderAvatar || 'üë§';
            let nameDisplay = v.uploaderName || 'An√≥nimo';
            let badge = '';

            // Si el nombre es ADMINISTRADOR, poner Escudo
            if(nameDisplay === 'ADMINISTRADOR') {
                avatarDisplay = 'üõ°Ô∏è';
                badge = '<span class="admin-badge">ADMIN</span>';
            }

            if(v.uploaderName) {
                uploaderHtml = `
                    <div style="display:flex; align-items:center; gap:8px; padding:0 15px 10px 15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <div style="width:20px; height:20px; border-radius:50%; background:#444; font-size:12px; display:flex; align-items:center; justify-content:center;">${avatarDisplay}</div>
                        <span style="font-size:11px; color:var(--text-muted);">${nameDisplay} ${badge}</span>
                    </div>
                `;
            }

            card.innerHTML = `
                <img src="${thumb}" class="video-thumb" onclick="window.open('${v.url}', '_blank')">
                <div class="video-info">
                    <div class="video-title">${v.title}</div>
                    <div class="video-desc">${v.desc||''}</div>
                </div>
                ${uploaderHtml}
                ${adminBtns}
            `;
            c.appendChild(card);
        });
    }

    // UTILS
    window.handleGenericForm = function(e, t, m) { if(e.target.action) return; e.preventDefault(); showModal(t, m); e.target.reset(); };
    window.showModal = function(t, m) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-msg').innerText=m; document.getElementById('success-modal').style.display='flex'; };
    window.closeModal = function() { document.getElementById('success-modal').style.display='none'; };
    
    window.uploadBookToCloud = async function() {
        const t = document.getElementById('pubTitle').value, a = document.getElementById('pubAuthor').value, l = document.getElementById('pubLink').value, c = document.getElementById('pubCover').value;
        const btn = document.querySelector('#publishForm .btn-neon');
        if(!t || !l) return alert("Faltan datos");
        btn.innerText = "‚è≥ ..."; btn.disabled = true;
        try { await addDoc(collection(db, "libros"), { title:t, author:a, pdfLink:l, cover:c, timestamp: serverTimestamp() }); showModal("Listo", "Libro subido."); document.getElementById('publishForm').reset(); window.navigate('recientes'); } 
        catch(e){alert(e.message);} finally { btn.innerText = "PUBLICAR AHORA"; btn.disabled = false; }
    };

    window.updateDailyVerse = async function() {
        try { await setDoc(doc(db, "configuracion", "versiculo_diario"), { title:document.getElementById('verseTitle').value, text:document.getElementById('verseText').value, image:document.getElementById('verseImgUrl').value, date: new Date().toLocaleDateString() }); showModal("Listo", "Vers√≠culo actualizado."); } catch(e){alert(e.message);}
    };
    window.deleteDailyVerse = async function() { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, "configuracion", "versiculo_diario")); };
    
    function renderVerse(d) {
        if(!d) { document.getElementById('displayVerseTitle').innerText=""; document.getElementById('displayVerseText').innerText="Esperando..."; document.getElementById('displayVerseImg').style.display='none'; return; }
        document.getElementById('displayVerseTitle').innerText=d.title; document.getElementById('displayVerseText').innerText=`"${d.text}"`; document.getElementById('verseDate').innerText=d.date;
        const img=document.getElementById('displayVerseImg'); if(d.image){img.src=d.image; img.style.display='block';}else{img.style.display='none';}
    }
    
    function startFallingLeaves() { if(leavesInterval) clearInterval(leavesInterval); const c=document.getElementById('versiculo-container'); leavesInterval=setInterval(()=>{if(c.querySelectorAll('.leaf').length>15)return; const l=document.createElement('div');l.className='leaf';l.style.left=Math.random()*90+"%";l.style.animationDuration=(Math.random()*3+4)+"s";l.onanimationend=()=>l.remove();c.appendChild(l);},800); }
    function stopFallingLeaves() { if(leavesInterval) clearInterval(leavesInterval); document.querySelectorAll('.leaf').forEach(e=>e.remove()); }
    function startRain() { if(rainInterval) clearInterval(rainInterval); const c=document.getElementById('videos'); rainInterval=setInterval(()=>{if(c.querySelectorAll('.rain').length>40)return; const r=document.createElement('div');r.className='rain';r.style.left=Math.random()*100+"%";r.style.animationDuration=(Math.random()*0.5+0.5)+"s";r.onanimationend=()=>r.remove();c.appendChild(r);},100); }
    function stopRain() { if(rainInterval) clearInterval(rainInterval); document.querySelectorAll('.rain').forEach(e=>e.remove()); }

    function stringToColor(str) { let hash=0; for(let i=0;i<str.length;i++) hash=str.charCodeAt(i)+((hash<<5)-hash); let c='#'; for(let i=0;i<3;i++) c+=('00'+((hash>>(i*8))&0xFF).toString(16)).substr(-2); return c; }
    function toggleFav(b, el) { const idx=favorites.findIndex(f=>f.title===b.title); if(idx===-1){favorites.push(b);if(el)el.classList.add('active');}else{favorites.splice(idx,1);if(el)el.classList.remove('active');if(document.getElementById('favoritos').classList.contains('active'))renderLibrary('grid-favoritos',favorites);} localStorage.setItem('my_fav_books',JSON.stringify(favorites)); }
    
    /* ================================================================= */
    /* === 8. L√ìGICA AVANZADA: AUTH, PERFIL Y MURO SOCIAL === */
    /* ================================================================= */

    /* --- A. AUTH & GESTI√ìN DE PERFIL (ONBOARDING) --- */
    window.loginWithGoogle = async () => {
        try { 
            const provider = new GoogleAuthProvider(); 
            provider.setCustomParameters({ prompt: 'select_account' });
            await signInWithRedirect(auth, provider); 
        } catch(e) { 
            alert("Error login: " + e.message); 
        }
    };

    window.logout = () => {
        signOut(auth);
        window.location.reload(); 
    };

    // MONITOR DE ESTADO
    onAuthStateChanged(auth, async (user) => {
        window.currentUser = user; 
        
        if (user) {
            // 1. USUARIO AUTENTICADO -> VERIFICAR PERFIL EN DB
            const userRef = doc(db, "usuarios", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                window.currentUserProfile = userSnap.data();
                if(window.currentUserProfile.status === 'bloqueado') {
                    alert("üö´ TU CUENTA HA SIDO BLOQUEADA POR EL ADMINISTRADOR.");
                }
                updateUserUI();
            } else {
                document.getElementById('profile-nick').value = user.displayName; 
                document.getElementById('profile-setup-modal').style.display = 'flex';
            }
        } else {
            updateUserUI(); // Actualizar UI incluso si no hay usuario (para caso Admin)
        }

        updateVideoUploadUI();
        initSocialFeed();
    });

    // --- CORRECCI√ìN SOLICITADA: INTERFAZ SOCIAL (PRIORIDAD ADMIN) ---
    function updateUserUI() {
        const loginPrompt = document.getElementById('feed-login-prompt');
        const createPostCard = document.getElementById('create-post-container');

        // Si es Admin, siempre puede postear. Si no, necesita usuario y perfil.
        const canPost = isAdminMode || (window.currentUser && window.currentUserProfile);

        if (canPost) {
            loginPrompt.style.display = 'none';
            createPostCard.style.display = 'block';

            // Si es Admin puro (sin login de google), forzar identidad visual en la caja
            if (isAdminMode && !window.currentUserProfile) {
                document.getElementById('user-name-display').innerText = "ADMINISTRADOR";
                document.getElementById('user-avatar-display').innerText = "üõ°Ô∏è";
            } else if (window.currentUserProfile) {
                document.getElementById('user-name-display').innerText = window.currentUserProfile.nickname;
                document.getElementById('user-avatar-display').innerText = window.currentUserProfile.avatar;
            }
        } else {
            // Si NO es admin y NO tiene usuario logueado, mostrar login
            loginPrompt.style.display = 'block';
            createPostCard.style.display = 'none';
        }
        
        updateVideoUploadUI();
    }

    // A.1 FUNCIONES DE PERFIL
    window.selectAvatar = (emoji, el) => {
        document.querySelectorAll('.avatar-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selected-avatar-val').value = emoji;
    };

    window.toggleSaveBtn = () => {
        const chk = document.getElementById('terms-check');
        const btn = document.getElementById('btn-save-profile');
        btn.disabled = !chk.checked;
        if(chk.checked) btn.style.opacity = "1"; else btn.style.opacity = "0.5";
    };

    window.showTerms = () => {
        document.getElementById('terms-modal').style.display = 'flex';
    };

    window.saveUserProfile = async () => {
        const nick = document.getElementById('profile-nick').value.trim();
        const avatar = document.getElementById('selected-avatar-val').value;
        const terms = document.getElementById('terms-check').checked;

        if(!nick || !avatar) return alert("Por favor elige un Nickname y un Avatar.");
        if(!terms) return alert("Debes aceptar los T√©rminos y Condiciones.");

        const userData = {
            uid: window.currentUser.uid,
            nickname: nick,
            avatar: avatar,
            email: window.currentUser.email,
            status: 'activo', 
            createdAt: serverTimestamp()
        };

        try {
            await setDoc(doc(db, "usuarios", window.currentUser.uid), userData);
            window.currentUserProfile = userData; 
            document.getElementById('profile-setup-modal').style.display = 'none';
            updateUserUI();
            showModal("¬°Bienvenido!", "Perfil creado con √©xito.");
        } catch(e) {
            alert("Error al guardar perfil: " + e.message);
        }
    };

    /* --- B. L√ìGICA H√çBRIDA DE VIDEOS (ADMIN vs USER) --- */
    
    window.updateVideoUploadUI = function() {
        const btnContainer = document.getElementById('btn-show-video-form');
        if (!btnContainer) return;
        // Mostrar bot√≥n si es Admin O si es Usuario Registrado
        if (isAdminMode || window.currentUserProfile) {
            btnContainer.style.display = 'block';
        } else {
            btnContainer.style.display = 'none';
        }
    };

    window.toggleVideoForm = function() {
        if (!isAdminMode && !window.currentUserProfile) {
            return alert("Para subir videos debes iniciar sesi√≥n.");
        }
        if (window.currentUserProfile && window.currentUserProfile.status === 'bloqueado') {
            return alert("üö´ Tu cuenta est√° bloqueada.");
        }
        const form = document.getElementById('video-upload-form');
        form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
    };

    window.uploadVideo = async function() {
        const t = document.getElementById('vidTitle').value;
        const d = document.getElementById('vidDesc').value;
        const u = document.getElementById('vidUrl').value;
        
        if(!t || !u) return alert("Faltan datos");

        let uploaderName, uploaderAvatar, uploaderUid;

        // --- L√≥gica de identidad Admin en Videos ---
        if (isAdminMode) {
            uploaderName = "ADMINISTRADOR";
            uploaderAvatar = "üõ°Ô∏è"; 
            uploaderUid = "admin_system";
        } else if (window.currentUserProfile) {
            if(window.currentUserProfile.status === 'bloqueado') return alert("Bloqueado");
            uploaderName = window.currentUserProfile.nickname;
            uploaderAvatar = window.currentUserProfile.avatar;
            uploaderUid = window.currentUser.uid;
        } else {
            return alert("Error de permisos.");
        }

        try { 
            await addDoc(collection(db, "videos"), { 
                title: t, desc: d, url: u, 
                timestamp: serverTimestamp(),
                uploaderUid: uploaderUid,
                uploaderName: uploaderName,
                uploaderAvatar: uploaderAvatar
            }); 
            showModal("Listo", "Video compartido con la comunidad."); 
            document.getElementById('video-upload-form').style.display = 'none'; 
            document.getElementById('vidTitle').value = '';
            document.getElementById('vidDesc').value = '';
            document.getElementById('vidUrl').value = '';
        } catch(e){
            alert(e.message);
        }
    };

    /* --- C. MURO SOCIAL (FEED) --- */
    let unsubscribeFeed = null;

    function initSocialFeed() {
        if(unsubscribeFeed) unsubscribeFeed();
        const container = document.getElementById('feed-container');
        if(!container) return;

        const q = query(collection(db, "publicaciones"), orderBy("timestamp", "desc"), limit(50));
        
        unsubscribeFeed = onSnapshot(q, (snapshot) => {
            container.innerHTML = ''; 
            if (snapshot.empty) {
                container.innerHTML = `<p style="text-align:center; color:#777; margin-top:20px">No hay publicaciones a√∫n.</p>`;
                return;
            }

            snapshot.forEach(docSnap => {
                const post = docSnap.data();
                const pid = docSnap.id;
                
                const likes = post.likes || [];
                const disagrees = post.disagrees || [];
                const userLiked = window.currentUser && likes.includes(window.currentUser.uid);
                const userDisagreed = window.currentUser && disagrees.includes(window.currentUser.uid);

                // BOTONES ADMIN (BORRAR / BANEAR)
                let adminControls = '';
                if (isAdminMode) {
                    adminControls = `
                        <button class="post-del-btn" onclick="deletePost('${pid}')">üóëÔ∏è</button>
                        <button class="ban-btn" onclick="banUser('${post.authorUid}', '${post.authorName}')">üö´ BAN</button>
                    `;
                }

                // Badge Admin en Posts
                let badge = '';
                if(post.authorName === 'ADMINISTRADOR') {
                    badge = '<span class="admin-badge">ADMIN</span>';
                }
                
                const card = document.createElement('div');
                card.className = 'social-card';
                card.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">${post.authorAvatar || '?'}</div>
                        <div class="post-meta">
                            <span class="post-author">
                                ${post.authorName || 'An√≥nimo'} ${badge}
                                ${adminControls}
                            </span>
                            <span class="post-date">${post.dateStr || ''}</span>
                        </div>
                    </div>
                    <div class="post-title">${post.title || ''}</div>
                    <div class="post-body">${post.text || ''}</div>
                    
                    <div class="social-actions">
                        <button class="action-btn ${userLiked ? 'liked' : ''}" onclick="interactPost('${pid}', 'like')">
                            üëç ${likes.length || 0}
                        </button>
                        <button class="action-btn ${userDisagreed ? 'disagreed' : ''}" onclick="interactPost('${pid}', 'disagree')">
                            üëé ${disagrees.length || 0}
                        </button>
                        <button class="action-btn" onclick="toggleComments('${pid}')">
                            üí¨ Comentar
                        </button>
                    </div>

                    <div id="comments-${pid}" class="comments-section">
                        <div id="comments-list-${pid}"></div>
                        ${(window.currentUser || isAdminMode) ? `
                            <form onsubmit="postComment(event, '${pid}')" style="display:flex; gap:5px; margin-top:10px;">
                                <input type="text" id="input-comment-${pid}" class="input-box" placeholder="Escribe un comentario..." style="margin:0; padding:8px; font-size:12px;">
                                <button type="submit" style="background:var(--accent); border:none; border-radius:4px; color:#000; font-weight:bold; cursor:pointer;">‚û§</button>
                            </form>
                        ` : `<p style="font-size:10px; color:#777; margin-top:5px">Reg√≠strate para comentar.</p>`}
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    /* --- D. ACCIONES SOCIALES --- */
    
    // --- CORRECCI√ìN SOLICITADA: PUBLICAR COMO ADMIN ---
    window.createPost = async () => {
        let title = document.getElementById('postTitle').value.trim();
        let text = document.getElementById('postBody').value.trim();
        if(!title || !text) return alert("Escribe algo.");

        let pName, pAvatar, pUid;

        // PRIORIDAD ADMIN
        if (isAdminMode) {
            pName = "ADMINISTRADOR";
            pAvatar = "üõ°Ô∏è";
            pUid = "admin_system";
        } 
        else {
            // Usuario Normal
            if(!window.currentUserProfile) return alert("Error de perfil.");
            if(window.currentUserProfile.status === 'bloqueado') return alert("üö´ Bloqueado.");
            pName = window.currentUserProfile.nickname;
            pAvatar = window.currentUserProfile.avatar;
            pUid = window.currentUser.uid;
        }

        try {
            await addDoc(collection(db, "publicaciones"), {
                title: title, text: text,
                authorName: pName,
                authorAvatar: pAvatar,
                authorUid: pUid,
                timestamp: serverTimestamp(),
                dateStr: new Date().toLocaleDateString(),
                likes: [], disagrees: []
            });
            document.getElementById('postTitle').value = '';
            document.getElementById('postBody').value = '';
            showModal("Publicado", "Tu tema est√° en el muro.");
        } catch(e) { alert("Error: " + e.message); }
    };

    window.interactPost = async (pid, type) => {
        if(!window.currentUser) return alert("Reg√≠strate para participar.");
        if(window.currentUserProfile && window.currentUserProfile.status === 'bloqueado') return alert("üö´ Bloqueado.");
        const uid = window.currentUser.uid;
        const ref = doc(db, "publicaciones", pid);
        try {
            if(type === 'like') await updateDoc(ref, { likes: arrayUnion(uid), disagrees: arrayRemove(uid) });
            else await updateDoc(ref, { disagrees: arrayUnion(uid), likes: arrayRemove(uid) });
        } catch(e) { console.error(e); }
    };

    /* --- E. SISTEMA DE BANEO Y BORRADO (ADMIN) --- */
    window.deletePost = async (pid) => {
        if(!confirm("ADMIN: ¬øBorrar post?")) return;
        try { await deleteDoc(doc(db, "publicaciones", pid)); } catch(e) { alert(e.message); }
    };

    window.banUser = async (targetUid, targetName) => {
        if(targetUid === 'admin_system') return alert("No puedes banear al admin.");
        if(!confirm(`ADMIN: ¬øBLOQUEAR a ${targetName}?\nNo podr√° publicar nada m√°s.`)) return;
        try {
            await updateDoc(doc(db, "usuarios", targetUid), { status: 'bloqueado' });
            alert(`üö´ Usuario ${targetName} bloqueado.`);
        } catch(e) { alert("Error: " + e.message); }
    };

    /* --- F. COMENTARIOS --- */
    window.toggleComments = (pid) => {
        const sec = document.getElementById(`comments-${pid}`);
        if(sec.style.display === 'none' || sec.style.display === '') {
            sec.style.display = 'block';
            loadComments(pid);
        } else {
            sec.style.display = 'none';
        }
    };

    function loadComments(pid) {
        const listDiv = document.getElementById(`comments-list-${pid}`);
        onSnapshot(query(collection(db, "publicaciones", pid, "comentarios"), orderBy("timestamp", "asc")), (snap) => {
            listDiv.innerHTML = '';
            snap.forEach(d => {
                const c = d.data();
                let adminBtns = '';
                if(isAdminMode) {
                    adminBtns = `<span onclick="deleteComment('${pid}', '${d.id}')" style="color:red; cursor:pointer; font-size:10px; margin-left:5px;">[x]</span>`;
                }
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${c.authorAvatar || ''} ${c.authorName} ${adminBtns}</span>
                        <span style="color:#555; font-size:9px">${c.dateStr}</span>
                    </div>
                    <div class="comment-text">${c.text}</div>
                `;
                listDiv.appendChild(item);
            });
        });
    }

    window.postComment = async (e, pid) => {
        e.preventDefault();
        const input = document.getElementById(`input-comment-${pid}`);
        const text = input.value.trim();
        if(!text) return;

        let cName, cAvatar, cUid;

        // Soporte Admin en Comentarios
        if (isAdminMode) {
            cName = "ADMINISTRADOR";
            cAvatar = "üõ°Ô∏è";
            cUid = "admin_system";
        } else {
            if(!window.currentUserProfile) return alert("Reg√≠strate para comentar.");
            if(window.currentUserProfile.status === 'bloqueado') return alert("üö´ Bloqueado.");
            cName = window.currentUserProfile.nickname;
            cAvatar = window.currentUserProfile.avatar;
            cUid = window.currentUser.uid;
        }

        try {
            await addDoc(collection(db, "publicaciones", pid, "comentarios"), {
                text: text,
                authorName: cName,
                authorAvatar: cAvatar,
                authorUid: cUid,
                timestamp: serverTimestamp(),
                dateStr: new Date().toLocaleDateString()
            });
            input.value = '';
        } catch(err) { alert("Error al comentar"); }
    };

    window.deleteComment = async (pid, cid) => {
        if(!confirm("ADMIN: ¬øBorrar comentario?")) return;
        await deleteDoc(doc(db, "publicaciones", pid, "comentarios", cid));
    };

    /* --- G. NOTAS PERSONALES --- */
    const localNotes = localStorage.getItem('my_personal_notes');
    if(localNotes) document.getElementById('user-notes').value = localNotes;
    window.saveNotes = () => {
        localStorage.setItem('my_personal_notes', document.getElementById('user-notes').value);
        document.getElementById('notes-modal').style.display = 'none';
        showModal("Notas Guardadas", "Tus notas est√°n seguras.");
    };

    /* --- H. INICIO --- */
    navigate('recientes');
    if(isAdminMode) {
        toggleAdminForms(true);
        updateUserUI(); // Asegurar estado al cargar si ya era admin
    }

</script>
<script src="https://pl28432883.effectivegatecpm.com/c6/1a/73/c61a737a59c460af3a624d83933f2177.js"></script>
</body>
</html>

